# K2 Geometry Kernel for VS1053b Demo

This is a simple demo of a geometry plugin for the VS1053b chip on the wildbits K2.

Plugin supports:
- translation, scale, 3-axis rotation for objects
- translation, 3-axis rotation for camera
- transformation of vertices into view coordinates
- projection and clipping of vertices into screen coordinates

NOTE: For performance clipping currently uses simple clamping to screen edges.  This can cause edge distortion, but it should be ok for gaming applications. Slope correct clipping may be added in the future.

Plugin is provided as:
- PLG generated by VSIDE
- a binary encoding which can be linked in the binary (e.g. llvm-mos EMBED).

Interface:
- Vertices, Edges, Triggering and Results are all read/write via SCI
- Data is packed where possible to reduce the number of SCI calls per frame.

Coordinates:
- world coordinates are from -16384 to 16383. 
- Y is up, X to the right and Z pointing toward the viewer
- see 3d_object.c for how object vertices are scaled in this particular demo.
- screen coordinates are properly oriented (0,0 upper left) so edges can be passed to line drawing.
- In this demo I keep the camera postion within 8192 units of the origin and all objects are relatively close to the origin.

Sequence of operation:
1. load and initialize the plugin
2. set projection params (```setup_projection_params(120, 160, 120, -256)```)
    - first param is to set vertical fov (120 is 90 deg)
    - mid points of x and y screen coords
    - near clipping plane (where edges clip in front of camera which is looking in neg direction)
3. Set camera params 
    - pitch, yaw, roll angles are 0-255 (2pi / 256)
    ```
    setup_camera_params(
                camera->pitch, camera->yaw, camera->roll,
                camera->position.x, camera->position.y, camera->position)
    ```
4. Load object vertices and edges into plugin
    - see geometry_kernel.c for how this is done
    - the demo uses a Model3D structure that has the vertices and edges for the object
    - functions setup_model_vertices and setup_model_edges write the values to the plugin
5. Set object parameters similar to camera.  Objects also support a Q7 scale where 128 = 1.0.  So it is possible to increase or decrease an object's size dynamically without reloading vertices.
6. Trigger the geometry kernel
7. Wait for the kernel to return a completion status of 0xABCD (geometry_kernel_wait_complete)
8. call get_screen_edges
    - this function writes edge info to a global list that is used by draw_lines_asm
9. use draw_lines_asm to write to the screen buffer
10. switch buffers, read input, move camera, etc. and do it again.

VS1053b memory use has been limited to X-RAM and Y-RAM that VLSI says won't conflict with audio processing.  However, this plugin does do a lot of crunching which impacts quality of simultaneous audio.  So generally it is an either/or situation.  with few objects on screen you may be able to get away with short effects.

## What's new
- Added eight object save slots to vs1053b memory so objects can be switched without reloading via SCI
- Demo 'M' key will display mixed objects
- O key selects the drone show.   I key selects an iron soldier like building destruct
- Added optional z based edge rendering. new api allows for rendering edges with a near or far color

## Build / Compile
- llvm-mos.   i used the version enhanced by andrew2936 in a WSL2 environment.
- Makefile should provide build hints.
- Or just use the interface code as a reference and use your own build workflow.

If you have questions I'm usually on the  wildbits computing discord (jbaker8935)
